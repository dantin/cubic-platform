os: linux
dist: xenial

language: java
jdk:
  - openjdk8

services:
  - docker

jobs:
  include:
  - stage: unit-tests
    before_install:
      - REPO_DIR=`pwd`
      - echo "CODE_PATH=$REPO_DIR" > $REPO_DIR/.env
    install:
      - make init
      - make env-up
    script:
      - make unit-test
    after_script:
      - make env-down
      - make prune

  - stage: test
    before_install:
      - REPO_DIR=`pwd`
      - echo "CODE_PATH=$REPO_DIR" > $REPO_DIR/.env
    install:
      - make image
      - make images
      - make init
      - make standalone-up
      - ./wait-for localhost:5432 -t 1000 -- echo 'postgres is up'
      - ./wait-for localhost:6379 -t 1000 -- echo 'redis is up'
      - ./wait-for localhost:8500 -t 1000 -- echo 'consul cluster is up'
      - ./wait-for localhost:9990 -t 1000 -- echo 'keycloak http is up'
      - ./wait-for localhost:9991 -t 1000 -- echo 'keycloak https is up'
      - ./wait-for localhost:8080 -t 1000 -- echo 'gateway is up'
    script:
      # with 5 minutes of timeout: if timeout is reached, it exits with error(1)
      - timeout 300 bash -c 'while [[ "$(curl -s -o /dev/null -w ''%{http_code}'' localhost:9990/auth/admin/master/console/)" != "200" ]]; do sleep 5 && echo "wait for keycloak"; done' || false
      - timeout 300 bash -c 'while [[ "$(curl -s -o /dev/null -w ''%{http_code}'' localhost:8080/actuator/health)" != "200" ]]; do sleep 5 && echo "wait for gateway"; done' || false
      - make test
      - echo "$TRAVIS_TAG"
    after_script:
      - make standalone-down
      - make prune

  - stage: publish
    if: tag IS present
    install:
      - make image
      - make images
    script:
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - make publish-images
      - make prune-images
