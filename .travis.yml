os: linux
dist: xenial

language: java
jdk:
  - openjdk8

services:
  - docker

jobs:
  include:
  - stage: unit-tests
    install:
    - REPO_DIR=`pwd`
    - echo "CODE_PATH=$REPO_DIR" > $REPO_DIR/.env
    - make init
    - make env-up
    script:
    - make vet
    - make unit-test
    - make env-down
    - make prune

  - stage: integration-tests
    install:
      - REPO_DIR=`pwd`
      - echo "CODE_PATH=$REPO_DIR" > $REPO_DIR/.env
      - make image
      - make images
      - make init
      - make standalone-up
    script:
      - ./wait-for localhost:8761 -t 1000 -- echo 'discovery-service is up'
      - ./wait-for localhost:9990 -t 1000 -- echo 'keycloak http is up'
      - ./wait-for localhost:9991 -t 1000 -- echo 'keycloak https is up'
      - ./wait-for localhost:8080 -t 1000 -- echo 'gateway is up'
      - make integration-test
      - make standalone-down
      - make prune
